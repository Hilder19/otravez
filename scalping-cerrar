def reconnect_to_mt5():
    """
    Intenta reconectar a MT5 en caso de desconexión.
    """
    mt5.shutdown()
    time.sleep(2)  # Espera corta para reconexión rápida
    if not mt5.initialize():
        print("Error al reconectar a MT5.")
        return False
    return True

def adjust_sl_tp_to_broker_limits(final_sl, new_tp, current_price, stop_level, symbol_info):
    """
    Ajusta SL y TP para cumplir con las restricciones de distancia mínima del broker.
    """
    digits = symbol_info.digits

    # Ajustar SL según restricciones del broker
    if abs(current_price - final_sl) < stop_level:
        final_sl = (current_price - stop_level if final_sl < current_price else current_price + stop_level)
        final_sl = round(final_sl, digits)

    # Ajustar TP según restricciones del broker
    if abs(new_tp - current_price) < stop_level:
        new_tp = (current_price + stop_level if new_tp > current_price else current_price - stop_level)
        new_tp = round(new_tp, digits)

    return final_sl, new_tp





# Archivo: scalping_close_positions.py
import MetaTrader5 as mt5

# Archivo: scalping_close_positions.py
import MetaTrader5 as mt5
import time



import MetaTrader5 as mt5
import time

import MetaTrader5 as mt5
import time




import MetaTrader5 as mt5
import time

def close_open_positions(symbol, tp_fixed=0.05, sl_fixed=0.05, verbose=False):
    """
    Cierra posiciones abiertas si alcanzan el Take Profit (TP) o Stop Loss (SL).
    
    Parámetros:
        symbol (str): Símbolo del mercado.
        tp_fixed (float): Take Profit fijo (en valor absoluto).
        sl_fixed (float): Stop Loss fijo (en valor absoluto).
        verbose (bool): Si es True, imprime información detallada.
    """
    # Inicializar conexión con MetaTrader 5
    if not mt5.initialize():
        print("MetaTrader 5 no pudo inicializarse.")
        return

    # Obtener posiciones abiertas para el símbolo
    positions = mt5.positions_get(symbol=symbol)
    if positions is None:
        print(f"Error al obtener posiciones abiertas para {symbol}: {mt5.last_error()}")
        return
    if len(positions) == 0:
        if verbose:
            print(f"No hay posiciones abiertas para {symbol}.")
        return

    successful_closes = 0
    failed_closes = 0

    for pos in positions:
        # Obtener el precio actual
        tick_info = mt5.symbol_info_tick(symbol)
        if not tick_info:
            if verbose:
                print(f"Error: No se pudo obtener información de precios para {symbol}.")
            continue

        # Determinar el precio actual según el tipo de operación
        current_price = tick_info.ask if pos.type == mt5.ORDER_TYPE_BUY else tick_info.bid

        # Verificar si se alcanzó el SL o TP
        if (pos.type == mt5.ORDER_TYPE_BUY and (current_price <= pos.sl or current_price >= pos.tp)) or \
           (pos.type == mt5.ORDER_TYPE_SELL and (current_price >= pos.sl or current_price <= pos.tp)):
            # Crear solicitud para cerrar la posición
            close_request = {
                "action": mt5.TRADE_ACTION_DEAL,
                "symbol": symbol,
                "volume": pos.volume,
                "type": mt5.ORDER_TYPE_SELL if pos.type == mt5.ORDER_TYPE_BUY else mt5.ORDER_TYPE_BUY,
                "price": current_price,
                "deviation": 2,
                "magic": pos.magic,
                "comment": "Cierre por SL/TP alcanzado",
                "type_time": mt5.ORDER_TIME_GTC,
                "type_filling": mt5.ORDER_FILLING_IOC,
            }

            # Enviar solicitud para cerrar la posición
            close_result = mt5.order_send(close_request)
            if close_result.retcode == mt5.TRADE_RETCODE_DONE:
                successful_closes += 1
                if verbose:
                    print(f"Posición {pos.ticket} cerrada correctamente.")
            else:
                failed_closes += 1
                if verbose:
                    print(f"Error al cerrar posición {pos.ticket}: {close_result.retcode}")

        # Espera para evitar saturar la API
        time.sleep(1)

    # Resumen de resultados
    print(f"Posiciones cerradas exitosamente: {successful_closes}, Fallidas: {failed_closes}")

    # Finalizar conexión con MetaTrader 5
    mt5.shutdown()
